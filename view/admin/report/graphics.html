<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard | Inicio</title>
    <link rel="shortcut icon" href="/admin/assets/images/logo.png">
    
    <!-- import style:js -->
    <script src="/admin/static/js/styles.js"></script>
    <style>
      .tooltip-inner {
        max-width: 210px;
      }
    </style>
  </head>

  <div class="container-scroller">
    <!-- partial:partials/_navbar.html -->
    <div id="navbar-content"></div>

    <!-- partial -->
    <div class="container-fluid page-body-wrapper">

    <!-- partial:partials/_sidebar.html -->
    <div id="sidebar-content"></div>

    <!-- partial -->
    <div class="main-panel">
      <div class="content-wrapper">
        <div class="row">
          <div class="col-md-12 grid-margin">
            <div class="card">
              <div class="card-body">
                <!-- <div class="row">
                  <div class="col-md-12">
                    <div class="d-sm-flex align-items-baseline report-summary-header">
                      <button type="button" class="btn btn-sm btn-light ml-auto" id="tooltipButton" data-html="true" data-bs-toggle="tooltip" data-placement="left" data-bs-placement="top" data-bs-trigger="manual" title="Buscando dados pela primeira vez" style="margin-bottom: -0.4525rem;"><i class="icon-refresh"></i></button>
                    </div>
                  </div>
                </div> -->
              
                <h4 class="card-title" style="text-transform: none;"><i class="fa fa-table"></i> <strong>Extrato</strong> no período</h4>
                <hr>
                <br>
                <form action="#" role="form" method="post" enctype="multipart/form-data">
                  <fieldset>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">Data Inicio: </label>
                          <input type="date" id="data_inicio" name="initial_date" class="form-control">
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">Data Final </label>
                          <input type="date" id="data_fim" name="final_date" class="form-control">
                        </div>
                      </div>

                      <div class="col-md-12">
                        <div style="text-align:center" class="col-md-12 margin-bottom-30">
                          <button name="pesquisar" value="pesquisar" id="buscarDados"
                            class="btn btn-wide btn-success">Pesquisar</button>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                </form>
                <br>



                <div class="row report-inner-cards-wrapper">
                  <div class=" col-md -6 col-xl report-inner-card">
                    <div class="inner-card-text">
                      <span class="report-title">DEPÓSITOS</span>
                      <h4><span id="a_deposits">R$ 00,00</span></h4>
                      <a class="report-count" href="/admin/report/wdperiod">Relatório</a>
                    </div>
                    <div class="inner-card-icon" style="background:#3388e3;color:#fff;">
                      <i class="icon-rocket"></i>
                    </div>
                  </div>
                  <div class="col-md-6 col-xl report-inner-card">
                    <div class="inner-card-text">
                      <span class="report-title">SAQUES</span>
                      <h4><span id="a_withdraw">R$ 00,00</span></h4>
                      <a class="report-count" href="/admin/report/wdperiod">Relatório</a>
                    </div>
                    <div class="inner-card-icon bg-danger">
                      <i class="icon-briefcase"></i>
                    </div>
                  </div>
                  <div class="col-md-6 col-xl report-inner-card">
                    <div class="inner-card-text">
                      <span class="report-title">APOSTAS</span>
                      <h4><span id="a_games">R$ 00,00</span></h4>
                      <a class="report-count" href="/admin/report/daygames">Relatório</a>
                    </div>
                    <div class="inner-card-icon bg-success">
                      <i class="icon-game-controller"></i>
                    </div>
                  </div>
                  <div class="col-md-6 col-xl report-inner-card">
                    <div class="inner-card-text">
                      <span class="report-title">PRÊMIOS</span>
                      <h4><span id="a_prizes">R$ 00,00</span></h4>
                      <a class="report-count" href="/admin/report/awarded">Relatório</a>
                    </div>
                    <div class="inner-card-icon" style="background:#edca1e;color:#fff;">
                      <i class="icon-trophy"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 grid-margin stretch-card">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title" style="text-transform: none;">Transações na semana</h4>
                <div class="aligner-wrapper">
                  <canvas id="sessionsDoughnutChart" height="210"></canvas>
                  <div class="wrapper d-flex flex-column justify-content-center absolute absolute-center">
                    <h2 class="text-center mb-0 font-weight-bold"><span id="total_dt">0</span></h2>
                    <small class="d-block text-center text-muted  font-weight-semibold mb-0">Total</small>
                  </div>
                </div>
                <div class="wrapper mt-4 d-flex flex-wrap align-items-cente">
                  <div class="d-flex">
                    <span class="square-indicator ml-2" style="background:#3388e3;color:#fff;"></span>
                    <p class="mb-0 ml-2">Depósitos</p>
                  </div>
                  <div class="d-flex">
                    <span class="square-indicator bg-danger ml-2"></span>
                    <p class="mb-0 ml-2">Saques</p>
                  </div>
                  <div class="d-flex">
                    <span class="square-indicator bg-success ml-2"></span>
                    <p class="mb-0 ml-2">Apostas</p>
                  </div>
                  
                  <div class="d-flex">
                    <span class="square-indicator ml-2" style="background:#edca1e;color:#fff;"></span>
                    <p class="mb-0 ml-2">Prêmios</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8 grid-margin stretch-card">
            <div class="card">
              <div class="card-body performane-indicator-card">
                <div class="d-sm-flex">
                  <h4 class="card-title flex-shrink-1" style="text-transform: none;">Visão geral do período</h4>
                  <p class="m-sm-0 ml-sm-auto flex-shrink-0">
                    <!-- <span class="data-time-range ml-0">7d</span>
                    <span class="data-time-range active">2w</span>
                    <span class="data-time-range">1m</span>
                    <span class="data-time-range">3m</span> -->
                    <span class="data-time-range"> De <span id="d_data_ini">--/--/----</span> Até <span id="d_data_fim">--/--/----</span></span>
                  </p>
                </div>
                <div class="d-sm-flex flex-wrap">
                  <div class="d-flex align-items-center">
                    <span class="dot-indicator bg-primary ml-2"></span>
                    <p class="mb-0 ml-2 text-muted font-weight-semibold">Depósitos (<span id="d_total">0</span>)</p>
                  </div>
                  <div class="d-flex align-items-center">
                    <span class="dot-indicator bg-info ml-2"></span>
                    <p class="mb-0 ml-2 text-muted font-weight-semibold"> Saques (<span id="s_total">0</span>)</p>
                  </div>
                  <div class="d-flex align-items-center">
                    <span class="dot-indicator bg-danger ml-2"></span>
                    <p class="mb-0 ml-2 text-muted font-weight-semibold">Apostas (<span id="a_total">0</span>)</p>
                  </div>
                  <div class="d-flex align-items-center">
                    <span class="dot-indicator bg-danger ml-2"></span>
                    <p class="mb-0 ml-2 text-muted font-weight-semibold">Prêmios (<span id="p_total">0</span>)</p>
                  </div>
                </div>
                <canvas id="performanceWeekLineChart" class="ct-chart mt-4" height="95"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- content-wrapper ends -->
      <div id="footer-content"></div>

  <!-- plugins:js -->
  <script src="/admin/assets/vendors/js/vendor.bundle.base.js"></script>
  <script src="/admin/assets/vendors/jquery-mask/dist/jquery.mask.min.js"></script>
  <script src="/admin/assets/vendors/sweetalert2/dist/sweetalert2.all.min.js"></script>
  <!-- import partials:js -->
  <script src="/admin/static/js/partials.js"></script>
  <script defer="defer" src="/admin/static/js/app.js"></script>
  <!-- Custom js for this page -->
  <script src="/admin/assets/js/dashboard.js"></script>
  <script src="/admin/assets/vendors/chart.js/Chart.min.js"></script>
 <!-- <script src="../admin/assets/vendors/chartist/chartist.min.js"></script> -->
  <!-- End custom js for this page -->
  <script src="/admin/assets/vendors/moment/moment.min.js"></script>
  <script src="/admin/assets/vendors/datatable/datatables.min.js"></script>
  <script src="/admin/assets/vendors/daterangepicker/daterangepicker.js"></script>

  <script>
    // document.addEventListener('DOMContentLoaded', function() {

      const dataInicioInput = $('#data_inicio');
      const dataFimInput = $('#data_fim');
      const buscarDadosBtn = $('#buscarDados');      

      const formattedCurrentDate = getFormattedCurrentDate();

      function getFormattedCurrentDate() {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;
        const currentDay = currentDate.getDate();
        return `${currentYear}-${currentMonth.toString().padStart(2, '0')}-${currentDay.toString().padStart(2, '0')}`;
      }

      inserirGraficoDoughnut();
      inserirGraficoLine();

      async function carregarDados(url) {
        try {
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();
          console.log(data)

          inserirDados(data);
          inserirGraficoDoughnut(data);
          inserirGraficoLine(data);
          buscarDadosBtn.prop('disabled', false);

          if (data.length === 0) {
            inserirGraficoDoughnut();
            inserirGraficoLine();
          }
        } catch (error) {
          console.log(error);
        } finally {
          buscarDadosBtn.prop('disabled', false);
          buscarDadosBtn.html('<i class="fa fa-search fa-2xl"></i>Pesquisar');
        }
      }

      dataInicioInput.val(getFormattedCurrentDate());
      dataFimInput.val(getFormattedCurrentDate());

      buscarDadosBtn.click(function(e) {
        e.preventDefault();

        const initialDate = dataInicioInput.val();
        const finalDate = dataFimInput.val();

        $(this).html(`<div class="spinner-border text-primary" role="status"></div>`);
        $(this).prop('disabled', true);
        const url = `/api_admin/transactions/report/extract/?initial_date=${initialDate}&final_date=${finalDate}`;
        carregarDados(url);
      });

      function formatTime(hours, minutes, seconds) {
        const padZero = (num) => (num < 10 ? `0${num}` : num);
          return `${padZero(hours)}:${padZero(minutes)}:${padZero(seconds)}`;
      }

      // function validarJSON(json) {
      //   return (
      //     json &&
      //     json.hasOwnProperty('campo_valores') &&
      //     json.hasOwnProperty('campo_totais') &&
      //     json.campo_valores.hasOwnProperty('amount_deposits') &&
      //     json.campo_valores.amount_deposits.length > 0 &&
      //     json.campo_totais.hasOwnProperty('total_deposits') &&
      //     json.campo_totais.total_deposits.length > 0
      //   );
      // }

      function inserirDados(data) {
        
        // const lastUpdate = parseInt(localStorage.getItem('last_update'), 10);

        // const now = new Date();
        // const nextUpdate = new Date(lastUpdate + TIME_UPDATE * 60 * 1000);
        // const diffMinutes = Math.max(0, Math.round((nextUpdate - now) / 1000 / 60));

        // // Use a função formatTime para obter a hora formatada
        // const nextUpdateFormatted = formatTime(nextUpdate.getHours(), nextUpdate.getMinutes(), nextUpdate.getSeconds());

        // // Exiba a mensagem na tela
        // const tooltipMessage = `Próxima atualização em ${nextUpdateFormatted}`;
        // tooltipButton.attr('title', tooltipMessage);
        // tooltip.update();
        
        $("#a_deposits").html(formatarValor(typeof data['campo_valores']['amount_deposits'][0]['amount'] == "undefined" ? '0' : data['campo_valores']['amount_deposits'][0]['amount']));
        $("#a_withdraw").html(formatarValor(typeof data['campo_valores']['amount_withdraws'][0]['amount'] == "undefined" ? '0' : data['campo_valores']['amount_withdraws'][0]['amount']));
        $("#a_games").html(formatarValor(typeof data['campo_valores']['amount_games'][0]['amount'] == "undefined" ? '0' : data['campo_valores']['amount_games'][0]['amount']));
        $("#a_prizes").html(formatarValor(typeof data['campo_valores']['amount_prizes'][0]['amount'] == "undefined" ? '0' : data['campo_valores']['amount_prizes'][0]['amount']));
        $("#total_dt").html(typeof data['campo_totais']['total'] == "undefined" ? '0' : data['campo_totais']['total']);
        
        $("#d_total").html(typeof data['campo_totais']['total_deposits'][0]['amount'] == "undefined" ? '0' : data['campo_totais']['total_deposits'][0]['amount']);
        $("#s_total").html(typeof data['campo_totais']['total_withdraws'][0]['amount'] == "undefined" ? '0' : data['campo_totais']['total_withdraws'][0]['amount']);
        $("#a_total").html(typeof data['campo_totais']['total_games'][0]['amount'] == "undefined" ? '0' : data['campo_totais']['total_games'][0]['amount']);
        $("#p_total").html(typeof data['campo_totais']['total_prizes'][0]['amount'] == "undefined" ? '0' : data['campo_totais']['total_prizes'][0]['amount']);

        // $("#d_data_ini").html(typeof data['campo_grafico']['gr_deposits'][0]['amoun'] == "undefined" ? '--/--/--' : data['campo_grafico']['gr_deposits'][0]['data']);
        // $("#d_data_fim").html(typeof data['campo_grafico']['gr_deposits'][6]['data'] == "undefined" ? '--/--/--' : data['campo_grafico']['gr_deposits'][6]['data']);
      }

      function formatarValor(valor) {

        if (valor !== null) {
          const valorNumerico = parseFloat(valor.replace(/[^\d.,]/g, '').replace(',', '.')); // Converter para número

          return valorNumerico.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL'
          });
        } else {
          // Trate o caso em que o valor é nulo
          return 'R$ 00,00';
        }
      }
    // });
  </script>  
 
  </body>
</html>


