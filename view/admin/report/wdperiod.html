<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard | Relatório Saques & Depositos</title>
    <link rel="shortcut icon" href="/admin/assets/images/logo.png">
    <link href="/admin/assets/vendors/datatable/buttons.dataTables.min.css" rel="stylesheet" type="text/css">

    <!-- import style:js -->
    <script src="/admin/static/js/styles.js"></script>

    <style>
      div.dt-button-collection {width: 400px;}
      div.dt-button-collection button.dt-button {display: inline-block;width: 32%;}
      div.dt-button-collection button.buttons-colvis {display: inline-block;width: 49%;}
      div.dt-button-collection h3 {margin-top: 5px;margin-bottom: 5px;font-weight: 100;border-bottom: 1px solid rgba(150, 150, 150, 0.5);font-size: 1em;padding: 0 1em;}
      div.dt-button-collection h3.not-top-heading {margin-top: 10px;}
    </style>
  </head>

  <div class="container-scroller">
    <!-- partial:partials/_navbar.html -->
    <div id="navbar-content"></div>

    <!-- partial -->
    <div class="container-fluid page-body-wrapper">

    <!-- partial:partials/_sidebar.html -->
    <div id="sidebar-content"></div>

    <!-- partial -->
    <div class="main-panel">
      <div class="content-wrapper">
        <!-- <div class="page-header">
          <h3 class="page-title">Cadastro <strong>Regiões</strong></h3>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="#">Regiões</a></li>
              <li class="breadcrumb-item active" aria-current="page">Lista</li>
            </ol>
          </nav>
        </div> -->

        <div class="col-lg-12 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <h4 class="card-title"><i class="fa fa-table"></i> Relatório <strong>Saques & Depositos</strong></h4>
                <!-- <p class="card-description"> Add class <code>.table-bordered</code></p> -->

                <button id="att_list" type="button" class="btn btn-sm btn-light" data-toggle="tooltip" title="Atualizar lista" style="margin-bottom: -0.4525rem;"><i class="icon-refresh"></i></button>
              </div>
              <hr>
              <br>

              <!--div class="col-md-12 mb-2">
                <div style="text-align:center" >
                  <button type="button" name="processar" id="processar" class="btn btn-success" onclick="processarTransaction();" style="background-color:#3240a8 !important;">Alterar todos para processamento</button>
                </div>
              </div-->

              <form id="pesquisa">
                <fieldset>
                  <div class="row">
                    <div class="col-md-3">
                      <div class="form-group">
                        <label class="form-label">Data Inicio </label>
                        <input type="date" id="data_inicio" name="initial_date" class="form-control">
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                        <label class="form-label">Data Final </label>
                        <input type="date" id="data_fim" name="final_date" class="form-control">
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                        <label class="form-label">Tipo Transação </label>
                        <select name="tipo" id="tipo" class="form-control">
                            <!-- <option value="">Todos</option> -->
                            <option value="1">Depósito</option>
                            <option value="2">Saque</option>
                          </select>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                        <label class="form-label">Status </label>
                        <select name="status" id="status" class="form-control">
                            <option value="">Todos</option>
                            <option value="1">Pendente</option>
                            <option value="2">Confirmado</option>
                            <option value="3" >Restituição</option>
                            <option value="4">Disputa</option>
                            <option value="5">Bloqueado</option>
                            <option value="6">Cancelado</option>
                          </select>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div style="text-align:center" class="col-md-12">
                        <button name="pesquisar" value="pesquisar" id="buscarDados" class="btn btn-wide btn-success">Pesquisar</button>
                      </div>
                    </div>
                  </div>
                </fieldset>
              </form>
              <br>

              <div class="row">
                <div class="col-md-12 mb-2">
                  <div id="tab" class="panel-content pagination2 table-responsive">
                    <table id="dtable" class="table table-striped">
                      <thead>
                        <tr>
                          <th width="5%">ID</th>
                          <th width="12%">Data / Tempo Espera</th>
                          <!-- <th width="12%">Tipo</th> -->
                          <th width="15%">Usuário</th>
                          <th width="10%">Pix</th>
                          <th width="10%">Montante</th>
                          <th width="10%">Status</th>
                        </tr>
                      </thead>
                      <tbody id="tbody">
                      </tbody>
                      <tfoot>
                        <tr>
                          <!-- <th></th> -->
                          <th></th>
                          <th></th>
                          <th colspan="4"></th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- content-wrapper ends -->
      <div id="footer-content"></div>

  <!-- plugins:js -->
  <script src="/admin/assets/vendors/js/vendor.bundle.base.js"></script>
  <!-- import partials:js -->
  <script src="/admin/static/js/partials.js"></script>
  <script defer="defer" src="/admin/static/js/app.js"></script>
  <script defer="defer" src="/admin/assets/js/utils.js"></script>
  
  <script src="/admin/assets/vendors/jquery-mask/dist/jquery.mask.min.js"></script>
  <script src="/admin/assets/vendors/sweetalert2/dist/sweetalert2.all.min.js"></script>
  <script src="/admin/assets/vendors/datatable/datatables.min.js"></script>
  <script src="/admin/assets/vendors/datatable/dataTables.buttons.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {

      $('[data-toggle="tooltip"]').tooltip();

      const dataInicioInput = $('#data_inicio');
      const dataFimInput = $('#data_fim');
      const statusInput = $('#status').val();
      const typeInput = $('#tipo').val();

      const buscarDadosBtn = $('#buscarDados');
      const atualizarListaBtn = $('#att_list');
      const formattedStartOfMonth = getFormattedStartOfMonth();
      const formattedCurrentDate = getFormattedCurrentDate();

      const dataApi = `/api_admin/transactions/?initial_date=${formattedCurrentDate}&final_date=${formattedCurrentDate}&type=${typeInput}&status=${statusInput}`;
      console.log(dataApi)

      const tabela = $('#dtable').DataTable({
        initComplete: function () {
          carregarDados(dataApi);
        },
        "dom": 'Bfrtip',
        "buttons": [
          {
            text: 'Exportar lista',
            extend: 'collection',
            className: 'custom-html-collection',
            buttons: [
              '<h3>Exportar</h3>',
              'pdf',
              'csv',
              'excel',
              '<h3 class="not-top-heading">Colunas selecionadas</h3>',
              'columnsToggle'
            ]
          }
        ],
        "footerCallback": function ( row, data, start, end, display ) {
          var api = this.api();

          // Calcular o total da coluna "amount"
          var totalValor = api.column(4, { search: 'applied' })
            .data()
            .reduce(function (a, b) {
              var parsedValue = parseFloat(b.replace(/[^\d.,]/g, '').replace(',', '.'));
              return a + parsedValue;
            }, 0);

          var totalQuantidade = data.length;
          var formattedTotalValor = totalValor.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL'
          });

          $(api.column(4).footer()).html(
            `<div class="d-flex justify-content-end mt-2 mb-2">Total quantidade:&nbsp;<span class="text-danger">${totalQuantidade}</span>&nbsp;&nbsp;&nbsp; Total valor: <span class="text-danger ">&nbsp;${formattedTotalValor}</span></div>`
          );
        },
        "drawCallback": function (settings) {
          // máscara de moeda
          $('.money').mask('000.000.000.000.000,00', {
            reverse: true
          });
        },
        "columns": [{
            "data": "transaction_id",
            "render": function(data, type, row) {
              if (!data) {
                return 'Não encontrado!';
              }

              return data;
            }
          },
          {
            "data": "created_at",
            "render": function(data, type, row) {
              if (!data) {
                return 'Não encontrado!';
              }

              return formatarDataHora(data);
            }
          },
          // {
          //   "data": "type",
          //   "render": function(data, type, row) {
          //     if (!data) {
          //       return 'Não encontrado!';
          //     } else if (row['type'] === 1) {
          //       data = 'Depósito';
          //     } else if (row['type'] === 2) {
          //       data = 'Saque';
          //     }

          //     return data;
          //   }
          // },
          {
            "data": "username",
            "render": function(data, type, row) {
              if (!data) {
                return 'Não encontrado';
              }

              return data;
            }
          },
          {
            "data": "copy_pix",
            "render": function(data, type, row) {
              if (!data) {
                return 'Não encontrado';
              }

              if (data.length > 50) {
                return data.replace(/(.{50})/g, '$1<br>');
              }
              return data;
            }
          },
          {
            "data": "amount",
            "render": function(data, type, row) {
              if (!data) {
                return 'Não encontrado!';
              }

              return `R$ <span class="money">${row['amount']}</span>`;
            }
          },
          {
            "data": "status",
            "render": function(data, type, row) {
              if (!data) {
                return "<label class='badge' style='background-color:grey;color:white;'>Não encontrado</label>";
              }

              if (data == '1') {
                status = "<label class='badge' style='background-color:orange;color:white;'>Pendente</label>";
              } else if (data == '2') {
                status = "<label class='badge badge-success'>Confirmado</label>";
              } else if (data == '3') {
                status = "<label class='badge badge-primary'>Restituição</label>";
              } else if (data == '4') {
                status = "<label class='badge badge-black'>Disputa</label>";
              } else if (data == '5') {
                status = "<label class='badge badge-info'>Bloqueado</label>";
              } else if (data == '6') {
                status = "<label class='badge badge-danger'>Cancelado</label>";
              } else {
                status = 'Não Informado';
              }
              return status;
            }
          }],
        'order': [
          [0, 'asc']
        ],
        "responsive": true,
        "pageLength": 25,
        "language": {
          emptyTable: '<div id="datatable_processing" class="dataTables_processingfetch" role="status"><div><div></div><div></div><div></div><div></div></div></div>'
        },
        "oLanguage": {
          "sUrl": "../../admin/assets/vendors/datatable/pt-br.json"
        }
      });

      function getFormattedStartOfMonth() {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;
        return `${currentYear}-${currentMonth.toString().padStart(2, '0')}-01`;
      }

      function getFormattedCurrentDate() {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;
        const currentDay = currentDate.getDate();
        return `${currentYear}-${currentMonth.toString().padStart(2, '0')}-${currentDay.toString().padStart(2, '0')}`;
      }

      dataInicioInput.val(getFormattedCurrentDate());
      dataFimInput.val(getFormattedCurrentDate());

      // get list
      async function carregarDados(apiAddress) {
        try {
          const response = await fetch(apiAddress, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();
          tabela.clear().rows.add(data).draw();

          if (data.length === 0) {
            const emptyMessage = 'Sem resultados';
            tabela.rows.add([]).draw();
            $('.dataTables_empty', tabela.table().container()).html(emptyMessage);
          }

          $('.money').mask('000.000.000.000.000,00', {
            reverse: true
          });

        } catch (error) {
          console.log(error);
        } finally {
          $('#datatable_processing').css('display', 'block');
          buscarDadosBtn.html('<i class="fa fa-search fa-2xl"></i>Pesquisar');
          atualizarListaBtn.html(`<i class="icon-refresh"></i>`);
        }
      }

      buscarDadosBtn.click(function(e) {
        e.preventDefault();

        const initialDate = dataInicioInput.val();
        const finalDate = dataFimInput.val();
        const type = $('#tipo').val();
        const status = $('#status').val();

        $(this).html(`<div class="spinner-border text-primary" role="status"></div>`);
        const url = `/api_admin/transactions/?initial_date=${initialDate}&final_date=${finalDate}&type=${type}&status=${status}`;
        carregarDados(url);
      });

      atualizarListaBtn.click(function(e) {
        e.preventDefault();

         $(this).html(`<div class="spinner-border spinner-border-sm" role="status"></div>`);

        tabela.clear().draw();
        carregarDados(dataApi);
      });
    });

    /*function recarregarDados(apiAddress) {
      $(this).html(`<div class="spinner-border spinner-border-sm" role="status"></div>`);

      tabela.clear().draw();
      carregarDados(apiAddress);
    }*/

  </script>
</body>
</html>
